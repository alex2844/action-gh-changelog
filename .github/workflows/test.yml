name: Test Action

on:
  push:
    branches: [main, master]
  pull_request:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build
        run: ./build.sh

      - name: Test - Empty repository (no tags)
        run: |
          cd /tmp
          rm -rf test-no-tags 2>/dev/null || true
          mkdir test-no-tags
          cd test-no-tags

          if [[ "$PWD" == *"$GITHUB_WORKSPACE"* ]]; then
            echo "‚ùå –û–®–ò–ë–ö–ê: –Ω–∞—Ö–æ–¥–∏–º—Å—è –≤ —Ä–∞–±–æ—á–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏!"
            exit 1
          fi

          git init
          git config user.name "Test"
          git config user.email "test@test.com"
          echo "test" > README.md
          git add .
          git commit -m "feat: first feature"
          echo "test2" >> README.md
          git add .
          git commit -m "fix: first fix"

          echo "üìù Test: Repository without tags"
          OUTPUT=$($GITHUB_WORKSPACE/dist/changelog -q 2>&1)
          echo "$OUTPUT"

          if ! echo "$OUTPUT" | grep -q "feat: first feature"; then
            echo "‚ùå Missing 'feat: first feature'"
            exit 1
          fi
          if ! echo "$OUTPUT" | grep -q "fix: first fix"; then
            echo "‚ùå Missing 'fix: first fix'"
            exit 1
          fi
          echo "‚úÖ Test passed"

      - name: Test - Single tag on HEAD
        run: |
          cd /tmp
          rm -rf test-one-tag 2>/dev/null || true
          mkdir test-one-tag
          cd test-one-tag

          if [[ "$PWD" == *"$GITHUB_WORKSPACE"* ]]; then
            echo "‚ùå –û–®–ò–ë–ö–ê: –Ω–∞—Ö–æ–¥–∏–º—Å—è –≤ —Ä–∞–±–æ—á–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏!"
            exit 1
          fi

          git init
          git config user.name "Test"
          git config user.email "test@test.com"
          echo "test" > README.md
          git add .
          git commit -m "feat: initial feature"
          git tag v1.0.0

          echo "üìù Test: Single tag on HEAD"
          OUTPUT=$($GITHUB_WORKSPACE/dist/changelog -q 2>&1)
          echo "$OUTPUT"

          if ! echo "$OUTPUT" | grep -q "feat: initial feature"; then
            echo "‚ùå Missing commit"
            exit 1
          fi
          echo "‚úÖ Test passed"

      - name: Test - Multiple tags with unreleased commits
        run: |
          cd /tmp
          rm -rf test-unreleased 2>/dev/null || true
          mkdir test-unreleased
          cd test-unreleased

          if [[ "$PWD" == *"$GITHUB_WORKSPACE"* ]]; then
            echo "‚ùå –û–®–ò–ë–ö–ê: –Ω–∞—Ö–æ–¥–∏–º—Å—è –≤ —Ä–∞–±–æ—á–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏!"
            exit 1
          fi

          git init
          git config user.name "Test"
          git config user.email "test@test.com"

          echo "v1" > file.txt
          git add .
          git commit -m "feat: version 1"
          git tag v1.0.0

          echo "v2" > file.txt
          git add .
          git commit -m "feat: version 2"
          git tag v2.0.0

          echo "unreleased" > file.txt
          git add .
          git commit -m "feat: unreleased feature"

          echo "üìù Test: Unreleased commits after tag"
          OUTPUT=$($GITHUB_WORKSPACE/dist/changelog -q 2>&1)
          echo "$OUTPUT"

          if ! echo "$OUTPUT" | grep -q "feat: unreleased feature"; then
            echo "‚ùå Missing unreleased commit"
            exit 1
          fi
          if echo "$OUTPUT" | grep -q "feat: version 1"; then
            echo "‚ùå Showing old commits (should only show unreleased)"
            exit 1
          fi
          echo "‚úÖ Test passed"

      - name: Test - Specific tag
        run: |
          cd /tmp
          rm -rf test-specific-tag 2>/dev/null || true
          mkdir test-specific-tag
          cd test-specific-tag

          if [[ "$PWD" == *"$GITHUB_WORKSPACE"* ]]; then
            echo "‚ùå –û–®–ò–ë–ö–ê: –Ω–∞—Ö–æ–¥–∏–º—Å—è –≤ —Ä–∞–±–æ—á–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏!"
            exit 1
          fi

          git init
          git config user.name "Test"
          git config user.email "test@test.com"

          echo "v1" > file.txt
          git add .
          git commit -m "feat: version 1"
          git tag v1.0.0

          echo "v2" > file.txt
          git add .
          git commit -m "feat: version 2"
          git tag v2.0.0

          echo "v3" > file.txt
          git add .
          git commit -m "feat: version 3"
          git tag v3.0.0

          echo "üìù Test: Specific tag (v2.0.0)"
          OUTPUT=$($GITHUB_WORKSPACE/dist/changelog -q -t v2.0.0 2>&1)
          echo "$OUTPUT"

          if ! echo "$OUTPUT" | grep -q "feat: version 2"; then
            echo "‚ùå Missing v2.0.0 commit"
            exit 1
          fi
          if echo "$OUTPUT" | grep -q "feat: version 3"; then
            echo "‚ùå Showing v3.0.0 (should only show v2.0.0)"
            exit 1
          fi
          echo "‚úÖ Test passed"

      - name: Test generation to file
        id: file_test
        uses: ./
        with:
          output: 'TEST_RESULT.md'
          lang: 'ru'

      - name: Check file existence
        run: |
          if [[ -f "TEST_RESULT.md" ]]; then
            echo "‚úÖ –§–∞–π–ª —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ"
            cat TEST_RESULT.md
          else
            echo "‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            exit 1
          fi

      - name: Test generation to stdout
        id: stdout_test
        uses: ./
        with:
          links: 'false'

      - name: Check outputs
        run: |
          if [[ -n "${{ steps.stdout_test.outputs.changelog }}" ]]; then
            echo "‚úÖ Output –ø–æ–ª—É—á–µ–Ω —É—Å–ø–µ—à–Ω–æ"
            echo "${{ steps.stdout_test.outputs.changelog }}"
          else
            echo "‚ùå Output –ø—É—Å—Ç–æ–π!"
            exit 1
          fi
